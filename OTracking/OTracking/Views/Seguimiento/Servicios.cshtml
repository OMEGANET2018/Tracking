<style>
    #Loading {
        background-color: rgba(0, 0, 0, 0.60);
        position: fixed;
        left: 0px;
        top: 0px;
        z-index: 9999;
    }

        #Loading > img {
            width: 200px;
        }

    .pagination-active span {
        color: #f39c12 !important;
    }

    #myModal .col-5, #myModal .col-7 {
        display: inline-block;
        margin: 10px 0px;
    }

    #myModal input, #myModal select{
        width:230px;
        height:40px;
    }

    #myModal .modal-body button{
        width: 50px;
        display:inline-block;
        padding:8px 0px;
        margin-left:10px;
        cursor:pointer;
    }
</style>
<div class="container-fluid">
    <div class="box box-default mt-2" id="acordion">
        <div class="box-header with-border" id="heading1">
            <h3 class="box-title" style="cursor:pointer;" onclick="ColapsarFiltro('collapse1')"><i class="icon-book-open"></i> Banjeda de Servicios</h3>
        </div>
        <div id="collapse1" class="box-body collapse show" aria-labelledby="heading1" style="overflow:hidden;">
            <div class="row">
                <div class="col-12 col-sm-4 col-lg-3 col-xl-3">
                    <div class="form-group">
                        <label for="">Nombre</label>
                        <input type="text" id="Nombre" class="form-control" maxlength="150" placeholder="Ingrese Nombre" />
                    </div>
                </div>
                <div class="col-12 col-sm-4 col-lg-3 col-xl-3">
                    <div class="form-group">
                        <label for="">Nro Documento</label>
                        <input type="text" id="NroDocumento" class="form-control" maxlength="150" placeholder="Ingrese Nro de Documento" />
                    </div>
                </div>
                <div class="col-6 col-sm-4 col-lg-2 col-xl-1">
                    <div class="form-group">
                        <label for=""></label>
                        <button class="btn-info boton form-control" onclick="Filtrar(1)" style="cursor:pointer;">
                            <i class="fa fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="RenderBandeja">
        @Html.Partial("_BandejaServiciosPartial")
    </div>
    @*<nav class="d-flex justify-content-end align-items-center flex-wrap">
        <div>
            <button class="btn-info boton form-control" onclick="location.href='#'" style="cursor:pointer;margin-bottom:20px;">
                <i class="fa fa-search"></i> Nuevo Usuario
            </button>
        </div>
    </nav>*@
</div>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title">Agendar Seguimiento</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
      <div class="modal-body">
        <div><div class="col-5">Tipo de Seguimeinto: </div><div class="col-7"><select id="TipoSeguimiento" onchange="CambioTipoSeguimiento(this); $(this).css('border-color','initial')">@{if (ViewBag.TipoSeguimeinto != null) { foreach (var T in ViewBag.TipoSeguimeinto) { <option value="@T.Id">@T.Value</option>} } }</select></div></div>
        <div><div class="col-5">Fecha: </div><div class="col-7"><input id="FechaSeguimiento" onclick="$(this).css('border-color','initial')" type="datetime-local" /></div></div>
        <div id="divTipoControl"><div class="col-5">Tipo de Control: </div><div class="col-7"><select id="ControlSeguimiento" onchange="$(this).css('border-color','initial')">@{if (ViewBag.TipoControl != null) { foreach (var T in ViewBag.TipoControl) { <option value="@T.Id">@T.Value</option>} } }</select></div></div>
        <div><div class="col-5">CIE10: </div><div class="col-7"><input id="CIE10" type="text" style="width:170px;" onkeyup="ObtenerDx(this); $(this).css('border-color','initial')"/><button type="button" class="btn-info boton form-control icon-plus" onclick="ValidarCIE10()"></button></div></div>
        <div style="padding:10px 25px 0px 15px;"><textarea readonly style="width:100%" id="DxDescripcion"></textarea></div>
        <div>
            <table class="table table-hover" style="width:100%;">
                <thead>
                    <tr><th>Descripción</th><th>Eliminar</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
      </div>
      <div class="modal-footer">
          <button type="button" style="cursor:pointer;" class="btn-info boton form-control" onclick="ValidarAgendar()">Aceptar</button>
          <button type="button" style="cursor:pointer;" class="btn-info boton form-control" data-dismiss="modal">Cerrar</button>
      </div>
    </div>

  </div>
</div>

<div class="alert" role="alert" style="display:none;">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>
    <span></span>
</div>

<div id="Loading" style="display:none;">
    <img src="~/Content/Images/loading.gif" />
</div>

<script>
    var xhr = null;
    function ColapsarFiltro(id) {
        setTimeout(function () {
            var height = 10;

            for (i = 0; i < $("#" + id + " .row").length; i++) {
                height = height + $($("#" + id + " .row")[i]).height();
            }

            if ($("#" + id).height() == 0) {
                $("#" + id).animate({ "height": height + "px", "padding": "10px" }, 400);
            } else {
                $("#" + id).animate({ "height": "0px", "padding": "0px 10px" }, 400);
            }
        }, 200);
    }

    function ColapsarTabla(id) {
        var Altura = $("#TablaAExportar").height() + 60;

        if ($("." + id).height() == 0) {
            $("." + id).animate({ "height": Altura + "px" }, 400);
        } else {
            alturaTabla = $("." + id).height();
            $("." + id).animate({ "height": "0px" }, 400);
        }
    }

    function Filtrar(index) {
        data = {
            Nombre: $("#Nombre").val(),
            NroDocumento: $("#NroDocumento").val(),
            Index: index,
            Take: $("#take").val()
        };

        var width = $(window).width();
        var height = $(window).height();
        $("#Loading").show().css("width", width + "px").css("height", height + "px");
        $("#Loading > img").css("margin-left", ((width - 200) / 2) + "px").css("margin-top", ((height - 266) / 2) + "px");

        $.ajax({
            cache: false,
            dataType: 'html',
            method: 'POST',
            data: data,
            url: '/Seguimiento/FiltrarServicios',
            success: function (html) {
                if (html.indexOf("IniciarSesion") == -1) {
                    $("#Loading").hide();
                    $("#RenderBandeja").html(html);
                } else {
                    location.href = "/";
                }

            },
            error: function (error) {
                alerta("Sucedió un error al conectarse al servidor", "rojo");
                $("#Loading").hide();
                console.log(error);
            }
        });
    }

    function AgendarPopup() {
        $("#myModal").modal();
        $("#myModal select").val(-1);
        $("#myModal input").val("");
        $("#myModal #divTipoControl").hide();
    }

    function CambioTipoSeguimiento(input) {
        $("#myModal table tbody").html("");

        if ($(input).val() == 2) {
            $("#myModal #divTipoControl").show();
            $("#myModal #divTipoControl select").css('border-color', 'initial').val(-1);
        } else{
            $("#myModal #divTipoControl").hide();
        }
    }

    function ValidarAgendar() {
        var valid = true;

        if ($("#myModal #TipoSeguimiento").val() == -1) {
            $("#myModal #TipoSeguimiento").css('border-color', 'red');
            valid = false;
        }

        if ($("#myModal #FechaSeguimiento").val() == "") {
            $("#myModal #FechaSeguimiento").css("border-color", "red");
            valid = false;
        } else if (moment($("#FechaSeguimiento").val())._d < new Date()) {
            $("#myModal #FechaSeguimiento").css("border-color", "red");
            valid = false;
        }

        if ($("#myModal #TipoSeguimiento").val() == 2) {
            if ($("#myModal #ControlSeguimiento").val() == -1) {
                $("#myModal #ControlSeguimiento").css("border-color", "red");
                valid = false;
            }
        }

        if ($("#myModal table tbody").html() == "") {
            $("#CIE10").css("border-color", "red");
            valid = false;
        }

        if (valid)
            Agendar();
    }

    function Agendar() {
        var data = {

        }

        alert("agendando");
    }

    function ValidarCIE10() {
        var valid = true;

        if ($("#myModal #TipoSeguimiento").val() == -1) {
            $("#myModal #TipoSeguimiento").css('border-color', 'red');
            valid = false;
        }

        if ($("#DxDescripcion").html() == "") {
            $("#CIE10").css("border-color", "red");
            valid = false;
        }

        if ($("#myModal table tbody:contains('" + $("#CIE10").val() + "')").length > 0) {
            $("#CIE10").css("border-color", "red");
            valid = false;
        }

        if (valid)
            InsertarCIE10();
    }

    function InsertarCIE10() {
        $("#CIE10").css("border-color", "initial");

        if ($("#myModal #TipoSeguimiento").val() == 2) {
            $("#myModal table tbody").html("");
        }

        $("#myModal table tbody").append("<tr><td>" + $("#CIE10").val() + "</td><td onclick='Eliminar(this)'><i class='icon-trash'></i></td></tr>");
    }

    function Eliminar(item) {
        $(item).parent().remove();
    }

    function ObtenerDx(input) {
        if ($(input).val().trim().length > 0) {
            if (xhr && xhr.readyState != 4)
                xhr.abort();

            xhr = $.ajax({
                cache: false,
                dataType: 'json',
                method: 'POST',
                data: { data: $(input).val().trim() },
                url: "/PlanesDeVida/ObtenerDxConCIE10",
                success: function (json) {
                    $("#DxDescripcion").html(json);
                },
                error: function () {
                    $("#DxDescripcion").html("");
                }
            });
        } else {
            $("#DxDescripcion").html("");
        }
    }
</script>