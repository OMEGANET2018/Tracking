<style>
    #Loading {
        background-color: rgba(0, 0, 0, 0.60);
        position: fixed;
        left: 0px;
        top: 0px;
        z-index: 9999;
    }

        #Loading > img {
            width: 200px;
        }

    .pagination-active span {
        color: #f39c12 !important;
    }

    #myModal table{
        margin-top:20px;
    }

    #myModal table thead tr{
        background-color:black;
        color:white;
        font-weight:bolder;
        text-align:center;
    }

    #myModal table tbody tr td{
        text-align:center !important;
    }

    #myModal table thead tr th:first-child{
        border-bottom-left-radius:10px;
        border-top-left-radius:10px;
    }

    #myModal table thead tr th:last-child {
        border-bottom-right-radius: 10px;
        border-top-right-radius: 10px;
    }
    .Suspendido {
        background-color: #989898;
        pointer-events: none;
    }
</style>
<div class="container-fluid">
    <div class="box box-default mt-2" id="acordion">
        <div class="box-header with-border" id="heading1">
            <h3 class="box-title" style="cursor:pointer;"><i class="icon-cogs"></i> Listado de Componentes</h3>
        </div>
        <div id="RenderBandejaComponentes">
            @Html.Partial("_BandejaComponentesPartial")
        </div>
    </div>

    <nav class="d-flex justify-content-end align-items-center flex-wrap">
        <div>
            <button class="btn-info boton form-control" onclick="NuevoComponente()" style="cursor:pointer;margin-bottom:20px;">
                <i class="fa fa-search"></i> Nuevo Componente
            </button>
        </div>
    </nav>
</div>

<!-- Modal -->
<div id="myModal" class="modal fade col-12 col-sm-8 offset-sm-2 col-md-6 offset-md-3" role="dialog" style="width:100%;">
    <div class="modal-dialog" style="max-width:100000px;">
        <form>
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"></h4>
                    <button type="button" class="close" data-dismiss="modal" style="outline:none;">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-8">
                            <label>Nombre</label>
                            <input type="text" id="padre-id" style="display:none;"/>
                            <input type="text" id="padre-status" style="display:none"/>
                            <input id="padre-valor" type="text" data-validation="length" data-validation-length="3-50" data-validation-error-msg="El Nombre debe de tener entre 3 y 50 caracteres" onkeypress="CambioNombrePadre()"/>
                        </div>
                        <div class="col-4">
                            <button type="button" class="btn-info boton form-control" style="cursor:pointer;" onclick="AgregarHijo()">Agregar Campo</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <table style="width:100%;">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Tipo Valor</th>
                                        <th>Minimo</th>
                                        <th>Maximo</th>
                                        <th>Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-info boton form-control" style="cursor:pointer;">Guardar</button>
                    <button type="button" class="btn-info boton form-control" style="cursor:pointer;" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<table id="tabla-mensaje-inicial" style="display:none;">
    <tbody>
        <tr id="tr-eliminar"><td colspan="4" class="text-center">No hay campos agregados</td></tr>
    </tbody>
</table>

<div id="hijo-base" style="display:none">
    <table>
        <tbody>
            <tr id="campo-base">
                <td><input type="text" id="campo-nombre" data-validation="required" onkeypress="CambioNombreHijo(this)"/></td>
                <td><select id="campo-valor" style="width:141px; height:24px;" data-validation="number" data-validation-allowing="range[1;100]" data-validation-error-msg="Debe seleccionar una opción" onchange="ChangeTipoValor(this)">
                    @foreach (var item in ViewBag.TipoValores)
                    {
                        <option value="@item.Id">@item.Value</option>
                    }
                    </select></td>
                <td><input type="number" id="campo-minimo" disabled onkeypress="CambioNombreHijo(this)"/></td>
                <td><input type="number" id="campo-maximo" disabled onkeypress="CambioNombreHijo(this)"/></td>
                <td><a onclick="DeleteHijo(this)"><span class="icon-trash"></span></a></td>
                <td style="display:none;"><input type="text" id="campo-id" value="0"/></td>
                <td style="display:none;"><input type="text" id="campo-status" value="2"/></td>
            </tr>
        </tbody>
    </table>
</div>

<div class="alert" role="alert" style="display:none;">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"></button>
    <span></span>
</div>

<div id="Loading" style="display:none;">
    <img src="~/Content/Images/loading.gif" />
</div>


@section scripts{
    <script src="~/Scripts/JqueryFormValidate.js"></script>
    <script src="~/Scripts/FormValidateSecurity.js"></script>
    <link href="~/Content/Themes/FormValidatorTheme.css" rel="stylesheet" type="text/css" />

    <script>
        $.validate();

        $('form').submit(function (event) {

            event.preventDefault();

            EnviarComponente();
        });

        function NuevoComponente() {
            $("#myModal").modal();
            $("#myModal .modal-title").html("Nuevo Componente");
            $("#myModal #padre-valor").val("").trigger("reset");
            $("#myModal table tbody").html($("#tabla-mensaje-inicial tbody").html());
            $("#myModal #padre-status").val(2);
            $("#myModal #padre-id").val(0);
        }

        function AgregarHijo() {
            if ($("#myModal #tr-eliminar").length > 0)
                $("#myModal #tr-eliminar").remove();

            $("#myModal table tbody").append($("#hijo-base tbody").html());
        }

        function ChangeTipoValor(select) {
            if ($(select).val() == 2) {
                $(select).parent().parent().children().children("#campo-minimo").prop("disabled", false);
                $(select).parent().parent().children().children("#campo-maximo").prop("disabled", false);
            } else{
                $(select).parent().parent().children().children("#campo-minimo").val("").prop("disabled", true);
                $(select).parent().parent().children().children("#campo-maximo").val("").prop("disabled", true);
            }
            CambioNombreHijo(select);
        }

        function EnviarComponente() {

            var Data =
            {
                ComponenteId: $("#myModal #padre-id").val(),
                RecordStatus: $("#myModal #padre-status").val(),
                Nombre: $("#myModal #padre-valor").val(),
                Lista: new Array()
            }

            for (i = 0; i < $("#myModal table tbody tr").length; i++) {
                var Hijo = {
                    ComponenteId: $($("#myModal table tbody tr")[i]).children().children("#campo-id").val(),
                    Nombre: $($("#myModal table tbody tr")[i]).children().children("#campo-nombre").val(),
                    TipoValorId: $($("#myModal table tbody tr")[i]).children().children("#campo-valor").val(),
                    ValorMinimo: $($("#myModal table tbody tr")[i]).children().children("#campo-minimo").val(),
                    ValorMaximo: $($("#myModal table tbody tr")[i]).children().children("#campo-maximo").val(),
                    RecordStatus: $($("#myModal table tbody tr")[i]).children().children("#campo-status").val()
                }

                Data.Lista.push(Hijo);
            }

            var width = $(window).width();
            var height = $(window).height();
            $("#Loading").show().css("width", width + "px").css("height", height + "px");
            $("#Loading > img").css("margin-left", ((width - 200) / 2) + "px").css("margin-top", ((height - 266) / 2) + "px");

            $.ajax({
                cache: false,
                dataType: 'json',
                method: 'POST',
                data: Data,
                url: '/Administracion/EnviarComponente',
                success: function (json) {
                    $("#Loading").hide();
                    if (json) {
                        alerta("Componente guardado!", "verde");
                        $("#myModal").modal("toggle");
                        UpdatePanel();
                    } else {
                        alerta("No se pudo Guardar el Componente", "rojo");
                    }
                },
                error: function (error) {
                    alerta("Sucedió un error al conectarse al servidor", "rojo");
                    $("#Loading").hide();
                    console.log(error);
                }
            });
        }

        function DeleteComponente(id) {
            var Data =
                {
                    RecordStatus: 4,
                    ComponenteId: id
                }

            var width = $(window).width();
            var height = $(window).height();
            $("#Loading").show().css("width", width + "px").css("height", height + "px");
            $("#Loading > img").css("margin-left", ((width - 200) / 2) + "px").css("margin-top", ((height - 266) / 2) + "px");

            $.ajax({
                cache: false,
                dataType: 'json',
                method: 'POST',
                data: Data,
                url: '/Administracion/EnviarComponente',
                success: function (json) {
                    $("#Loading").hide();
                    if (json) {
                        alerta("Componente eliminado!", "verde");
                        $("#myModal").modal("toggle");
                        UpdatePanel();
                    } else {
                        alerta("No se pudo eliminar el Componente", "rojo");
                    }
                },
                error: function (error) {
                    alerta("Sucedió un error al conectarse al servidor", "rojo");
                    $("#Loading").hide();
                    console.log(error);
                }
            });
        }

        function UpdateComponente(id) {
            $("#myModal").modal();
            $("#myModal .modal-title").html("Actualizar Componente");
            $("#myModal #padre-valor").val($("#componente-" + id + " #padre-valor").html()).trigger("reset");
            $("#myModal #padre-status").val(1);
            $("#myModal #padre-id").val(id);
            $("#myModal table tbody").html($("#tabla-mensaje-inicial tbody").html());

            for (i = 0; i < $("#componente-" + id + " table tbody tr").length; i++) {
                AgregarHijo();
                $($("#myModal table tbody tr")[i]).children().children("#campo-nombre").val($($("#componente-" + id + " table tbody tr")[i]).children("#campo-nombre").html());
                $($("#myModal table tbody tr")[i]).children().children("#campo-valor").val($($("#componente-" + id + " table tbody tr")[i]).children("#campo-valor").html());
                ChangeTipoValor($($("#myModal table tbody tr")[i]).children().children("#campo-valor"));
                $($("#myModal table tbody tr")[i]).children().children("#campo-minimo").val($($("#componente-" + id + " table tbody tr")[i]).children("#campo-minimo").html());
                $($("#myModal table tbody tr")[i]).children().children("#campo-maximo").val($($("#componente-" + id + " table tbody tr")[i]).children("#campo-maximo").html());
                $($("#myModal table tbody tr")[i]).children().children("#campo-status").val(1);
                $($("#myModal table tbody tr")[i]).children().children("#campo-id").val($($("#componente-" + id + " table tbody tr")[i]).children("#campo-id").html());
            }
        }

        function CambioNombrePadre() {
            if ($("#myModal #padre-status").val() == 1)
                $("#myModal #padre-status").val(3);
        }

        function CambioNombreHijo(campo) {
            if ($(campo).parent().parent().children().children("#campo-status").val() == 1)
                $(campo).parent().parent().children().children("#campo-status").val(3);
        }

        function DeleteHijo(campo) {
            if ($(campo).parent().parent().children().children("#campo-status").val() == 2) {
                $(campo).parent().parent().remove();
            } else if ($(campo).parent().parent().children().children("#campo-status").val() != 4){
                $(campo).parent().parent().children().children("#campo-status").val(4);
                $(campo).parent().parent().children().children("a").attr("onclick", "");
                $(campo).parent().parent().addClass("Suspendido");
            }
        }

        function UpdatePanel() {
            var width = $(window).width();
            var height = $(window).height();
            $("#Loading").show().css("width", width + "px").css("height", height + "px");
            $("#Loading > img").css("margin-left", ((width - 200) / 2) + "px").css("margin-top", ((height - 266) / 2) + "px");

            $.ajax({
                cache: false,
                dataType: 'html',
                method: 'POST',
                url: '/Administracion/ObtenerListadoComponentes',
                success: function (html) {
                    $("#Loading").hide();
                    $("#RenderBandejaComponentes").html(html);
                },
                error: function (error) {
                    alerta("Sucedió un error al conectarse al servidor", "rojo");
                    $("#Loading").hide();
                    console.log(error);
                }
            });
        }
    </script>

}